<!-- dashboard/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacelift Operations Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <nav class="bg-indigo-600 text-white p-4">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold">Spacelift Operations</h1>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm">Total Stacks</h3>
                <p class="text-3xl font-bold" id="total-stacks">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm">Healthy</h3>
                <p class="text-3xl font-bold text-green-600" id="healthy-stacks">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm">Failed</h3>
                <p class="text-3xl font-bold text-red-600" id="failed-stacks">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm">Running</h3>
                <p class="text-3xl font-bold text-blue-600" id="running-stacks">-</p>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-gray-500 text-sm">Health</h3>
                <p class="text-3xl font-bold text-indigo-600" id="health-pct">-</p>
            </div>
        </div>

        <!-- Environment Health -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-6" id="env-development">
                <h3 class="text-lg font-semibold text-blue-600 mb-2">Development</h3>
                <div class="space-y-2">
                    <div class="text-2xl font-bold">-</div>
                    <div class="text-sm text-gray-500">stacks</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6" id="env-staging">
                <h3 class="text-lg font-semibold text-yellow-600 mb-2">Staging</h3>
                <div class="space-y-2">
                    <div class="text-2xl font-bold">-</div>
                    <div class="text-sm text-gray-500">stacks</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6" id="env-production">
                <h3 class="text-lg font-semibold text-green-600 mb-2">Production</h3>
                <div class="space-y-2">
                    <div class="text-2xl font-bold">-</div>
                    <div class="text-sm text-gray-500">stacks</div>
                </div>
            </div>
        </div>

        <!-- Recent Runs -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">Recent Runs</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stack</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">State</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Changes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                        </tr>
                    </thead>
                    <tbody id="runs-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- All Stacks -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold">All Stacks</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Space</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">State</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Labels</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stacks-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function getStateColor(state) {
            const colors = {
                'FINISHED': 'bg-green-100 text-green-800',
                'FAILED': 'bg-red-100 text-red-800',
                'RUNNING': 'bg-blue-100 text-blue-800',
                'QUEUED': 'bg-yellow-100 text-yellow-800',
                'PREPARING': 'bg-yellow-100 text-yellow-800',
                'UNCONFIRMED': 'bg-purple-100 text-purple-800',
                'CANCELED': 'bg-gray-100 text-gray-800'
            };
            return colors[state] || 'bg-gray-100 text-gray-800';
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        async function fetchOverview() {
            const response = await fetch('/api/overview');
            const data = await response.json();

            document.getElementById('total-stacks').textContent = data.total_stacks;
            document.getElementById('healthy-stacks').textContent = data.healthy;
            document.getElementById('failed-stacks').textContent = data.failed;
            document.getElementById('running-stacks').textContent = data.running;
            document.getElementById('health-pct').textContent = data.health_percentage + '%';
        }

        async function fetchEnvironments() {
            const response = await fetch('/api/environments');
            const envs = await response.json();

            envs.forEach(env => {
                const el = document.getElementById(`env-${env.environment}`);
                if (el) {
                    el.querySelector('.text-2xl').textContent =
                        `${env.health_percentage}% (${env.healthy}/${env.total})`;
                    el.querySelector('.text-sm').textContent =
                        `${env.healthy} healthy, ${env.failed} failed`;
                }
            });
        }

        async function fetchRecentRuns() {
            const response = await fetch('/api/recent-runs');
            const runs = await response.json();

            const tbody = document.getElementById('runs-table');
            tbody.innerHTML = runs.map(run => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">${run.stackName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStateColor(run.state)}">${run.state}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${run.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="text-green-600">+${run.delta?.addCount || 0}</span>
                        <span class="text-yellow-600 ml-2">~${run.delta?.changeCount || 0}</span>
                        <span class="text-red-600 ml-2">-${run.delta?.deleteCount || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatTime(run.createdAt)}</td>
                </tr>
            `).join('');
        }

        async function fetchStacks() {
            const response = await fetch('/api/stacks');
            const stacks = await response.json();

            const tbody = document.getElementById('stacks-table');
            tbody.innerHTML = stacks.map(stack => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium">
                        ${stack.name}
                        ${stack.locked ? '<span class="ml-2 text-yellow-500">ðŸ”’</span>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stack.space}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full ${getStateColor(stack.state)}">${stack.state}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${stack.labels.map(l => `<span class="px-1 py-0.5 bg-gray-100 rounded text-xs mr-1">${l}</span>`).join('')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="triggerRun('${stack.id}')" 
                                class="text-indigo-600 hover:text-indigo-900">
                            Trigger Run
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function triggerRun(stackId) {
            if (!confirm('Trigger a new run for this stack?')) return;

            const response = await fetch(`/api/stack/${stackId}/trigger`, { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                alert(`Run triggered: ${data.run.id}`);
                fetchRecentRuns();
            } else {
                alert(`Error: ${data.error}`);
            }
        }

        async function init() {
            await Promise.all([
                fetchOverview(),
                fetchEnvironments(),
                fetchRecentRuns(),
                fetchStacks()
            ]);

            // Refresh every 30 seconds
            setInterval(() => {
                fetchOverview();
                fetchRecentRuns();
            }, 30000);
        }

        init();
    </script>
</body>

</html>